using System.Text;
using AVCoders.Core;
using Moq;
using Xunit.Abstractions;

namespace AVCoders.Display.Tests;

public class NecUhdExternalControlTest
{
    private readonly ITestOutputHelper _testOutputHelper;
    private NecUhdExternalControl _display;
    private readonly Mock<TcpClient> _mockClient;
    private readonly Mock<PowerStateHandler> _mockPowerStateHandler;
    private readonly Mock<InputHandler> _mockInputHandler;
    private readonly Mock<VolumeLevelHandler> _mockVolumeLevelHandler;

    public NecUhdExternalControlTest(ITestOutputHelper testOutputHelper)
    {
        _testOutputHelper = testOutputHelper;
        _mockClient = new Mock<TcpClient>("foo", NecUhdExternalControl.DefaultPort, "bar");
        _display = new NecUhdExternalControl(_mockClient.Object, "Test display", Input.Hdmi1, (byte)'A');
        _mockPowerStateHandler = new Mock<PowerStateHandler>();
        _display.PowerStateHandlers += _mockPowerStateHandler.Object;
        _mockInputHandler = new Mock<InputHandler>();
        _display.InputHandlers += _mockInputHandler.Object;
        _mockVolumeLevelHandler = new Mock<VolumeLevelHandler>();
        _display.VolumeLevelHandlers += _mockVolumeLevelHandler.Object;
    }
    
    [Fact]
    public void PowerOff_SendsThePowerOffCommand()
    {
        byte[] expectedPowerCommand = { 0x01, 0x30, 0x41, 0x30, 0x41, 0x30, 0x43, 0x02, 
            (byte)'C', (byte)'2', (byte)'0', (byte)'3', (byte)'D', (byte)'6', (byte)'0', (byte)'0', (byte)'0', (byte)'4', 0x03, 0x76, 0x0d };
        _display.PowerOff();

        _mockClient.Verify(x => x.Send(expectedPowerCommand), Times.Once);
    }

    // [Fact]
    // public void PowerOff_UsesTheCorrectDisplayId()
    // {
    //     NecUhdExternalControl samsungMdcForDisplay2 = new NecUhdExternalControl(0x03, _mockClient.Object);
    //     byte[] expectedPowerOnCommand = { 0xAA, 0x11, 0x03, 0x01, 0x00, 0x15 };
    //
    //     samsungMdcForDisplay2.PowerOff();
    //     _mockClient.Verify(x => x.Send(expectedPowerOnCommand), Times.Once);
    // }

    [Fact]
    public void PowerOn_SendsThePowerOnCommand()
    {
        byte[] expectedPowerOnCommand = { 0x01, 0x30, 0x41, 0x30, 0x41, 0x30, 0x43, 0x02, 0x43, 0x32, 0x30, 0x33, 0x44, 0x36, 0x30, 0x30, 0x30, 0x31, 0x03, 0x73, 0x0d };
        _display.PowerOn();

        _mockClient.Verify(x => x.Send(expectedPowerOnCommand), Times.Once);
    }

    // [Fact]
    // public void PowerOn_UsesTheCorrectDisplayId()
    // {
    //     SamsungMdc samsungMdcForDisplay2 = new SamsungMdc(0x02, _mockClient.Object);
    //     byte[] expectedPowerOnCommand = { 0xAA, 0x11, 0x02, 0x01, 0x01, 0x15 };
    //
    //     samsungMdcForDisplay2.PowerOn();
    //     _mockClient.Verify(x => x.Send(expectedPowerOnCommand), Times.Once);
    // }
    
    [Theory]
    [InlineData(Input.Hdmi1, new byte[] { 0x01, 0x30, 0x41, 0x30, 0x45, 0x30, 0x41, 0x02, 0x30, 0x30, 0x36, 0x30, 0x30, 0x30, 0x31, 0x31, 0x03, 0x72, 0x0d })]
    [InlineData(Input.Hdmi2, new byte[] { 0x01, 0x30, 0x41, 0x30, 0x45, 0x30, 0x41, 0x02, 0x30, 0x30, 0x36, 0x30, 0x30, 0x30, 0x31, 0x32, 0x03, 0x71, 0x0d })]
    [InlineData(Input.Hdmi3, new byte[] { 0x01, 0x30, 0x41, 0x30, 0x45, 0x30, 0x41, 0x02, 0x30, 0x30, 0x36, 0x30, 0x30, 0x30, 0x38, 0x32, 0x03, 0x78, 0x0d })]
    [InlineData(Input.Hdmi4, new byte[] { 0x01, 0x30, 0x41, 0x30, 0x45, 0x30, 0x41, 0x02, 0x30, 0x30, 0x36, 0x30, 0x30, 0x30, 0x38, 0x33, 0x03, 0x79, 0x0d })]
    public void SetInput_SendsTheExpectedCommand(Input source, byte[] command)
    {
        _display.SetInput(source);

        _mockClient.Verify(x => x.Send(command), Times.Once);
    }
    
    [Theory]
    [InlineData(0,   new byte[] { 0x01, 0x30, 0x41, 0x30, 0x45, 0x30, 0x41, 0x02, 0x30, 0x30, 0x36, 0x32, 0x30, 0x30, 0x30, 0x30, 0x03, 0x70, 0x0d })]
    [InlineData(1,   new byte[] { 0x01, 0x30, 0x41, 0x30, 0x45, 0x30, 0x41, 0x02, 0x30, 0x30, 0x36, 0x32, 0x30, 0x30, 0x30, 0x31, 0x03, 0x71, 0x0d })]
    [InlineData(100, new byte[] { 0x01, 0x30, 0x41, 0x30, 0x45, 0x30, 0x41, 0x02, 0x30, 0x30, 0x36, 0x32, 0x30, 0x30, 0x36, 0x34, 0x03, 0x72, 0x0d })]
    public void SetVolume_SendsTheExpectedCommand(int volume, byte[] command)
    {
        _display.SetVolume(volume);

        _mockClient.Verify(x => x.Send(command), Times.Once);
    }
    
    [Theory]
    [InlineData(MuteState.On,   new byte[] { 0x01, 0x30, 0x41, 0x30, 0x45, 0x30, 0x41, 0x02, 0x30, 0x30, 0x38, 0x44, 0x30, 0x30, 0x30, 0x31, 0x03, 0x09, 0x0d })]
    [InlineData(MuteState.Off,   new byte[] { 0x01, 0x30, 0x41, 0x30, 0x45, 0x30, 0x41, 0x02, 0x30, 0x30, 0x38, 0x44, 0x30, 0x30, 0x30, 0x32, 0x03, 0x0A, 0x0d })]
    public void SetAudioMute_SendsTheExpectedCommand(MuteState state, byte[] command)
    {
        _display.SetAudioMute(state);

        foreach (IInvocation x in _mockClient.Invocations)
        {
            foreach (Object xArgument in x.Arguments)
            {
                if (xArgument.GetType() == typeof(Byte[]))
                {
                    byte[] bytes = (byte[])xArgument;
                    _testOutputHelper.WriteLine(Encoding.ASCII.GetString(bytes));
                }
            }
        }

        _mockClient.Verify(x => x.Send(command), Times.Once);
    }

    [Theory]
    [InlineData(new byte[] { 0x01, 0x30, 0x30, 0x41, 0x42, 0x31, 0x32, 0x02, 0x30, 0x32, 0x30, 0x30, 0x44, 0x36, 0x30, 0x30, 0x30, 0x30, 0x30, 0x34, 0x30, 0x30, 0x30, 0x31, 0x03, 0x74, 0x0D }, PowerState.On)]
    [InlineData(new byte[] { 0x01, 0x30, 0x30, 0x41, 0x42, 0x31, 0x32, 0x02, 0x30, 0x32, 0x30, 0x30, 0x44, 0x36, 0x30, 0x30, 0x30, 0x30, 0x30, 0x34, 0x30, 0x30, 0x30, 0x34, 0x03, 0x71, 0x0D }, PowerState.Off)]
    public void ResponseHandler_HandlesPowerResponses(byte[] response, PowerState expectedPowerState)
    {
        _mockClient.Object.ResponseByteHandlers!.Invoke(response);
        _mockPowerStateHandler.Verify(x => x.Invoke(expectedPowerState));
    }

    [Fact]
    public void ResponseHandler_HandlesPartialPowerResponses()
    {
        var response1 = new byte[]
            { 0x01, 0x30, 0x30, 0x41, 0x42, 0x31, 0x32, 0x02, 0x30, 0x32, 0x30, 0x30, 0x44, 0x36 };
        var response2 = new byte[] { 0x30, 0x30, 0x30, 0x30, 0x30, 0x34, 0x30, 0x30, 0x30, 0x31, 0x03, 0x74, 0x0D };
        _mockClient.Object.ResponseByteHandlers!.Invoke(response1);
        _mockClient.Object.ResponseByteHandlers!.Invoke(response2);
        _mockPowerStateHandler.Verify(x => x.Invoke(PowerState.On));
    }

    [Theory]
    [InlineData(new byte[] { 0x01, 0x30, 0x30, 0x41, 0x44, 0x31, 0x32, 0x02, 0x30, 0x30, 0x30, 0x30, 0x36, 0x30, 0x30, 0x30, 0x30, 0x30, 0x38, 0x38, 0x30, 0x30, 0x31, 0x31, 0x03, 0x01, 0x0D }, Input.Hdmi1)]
    [InlineData(new byte[] { 0x01, 0x30, 0x30, 0x41, 0x44, 0x31, 0x32, 0x02, 0x30, 0x30, 0x30, 0x30, 0x36, 0x30, 0x30, 0x30, 0x30, 0x30, 0x38, 0x38, 0x30, 0x30, 0x31, 0x32, 0x03, 0x02, 0x0D }, Input.Hdmi2)]
    public void ResponseHandler_HandlesInputResponses(byte[] response, Input expectedInput)
    {
        
        _mockClient.Object.ResponseByteHandlers!.Invoke(response);
        _mockInputHandler.Verify(x => x.Invoke(expectedInput));
    }

    [Fact]
    public void ResponseHandler_HandlesPartialInputResponses()
    {
        var response1 = new byte[] { 0x01, 0x30, 0x30, 0x41, 0x44, 0x31, 0x32, 0x02, 0x30, 0x30, 0x30, 0x30, 0x36, 0x30 };
        var response2 = new byte[] { 0x30, 0x30, 0x30, 0x30, 0x38, 0x38, 0x30, 0x30, 0x31, 0x31, 0x03, 0x01, 0x0D };
        _mockClient.Object.ResponseByteHandlers!.Invoke(response1);
        _mockClient.Object.ResponseByteHandlers!.Invoke(response2);
        _mockInputHandler.Verify(x => x.Invoke(Input.Hdmi1));
    }
    
    [Theory]
    [InlineData(new byte[] { 0x01, 0x30, 0x30, 0x41, 0x44, 0x31, 0x32, 0x02, 0x30, 0x30, 0x30, 0x30, 0x36, 0x32, 0x30, 0x30, 0x30, 0x30, 0x36, 0x34, 0x30, 0x30, 0x30, 0x30, 0x03, 0x01, 0x0D }, 0)]
    [InlineData(new byte[] { 0x01, 0x30, 0x30, 0x41, 0x44, 0x31, 0x32, 0x02, 0x30, 0x30, 0x30, 0x30, 0x36, 0x32, 0x30, 0x30, 0x30, 0x30, 0x36, 0x34, 0x30, 0x30, 0x31, 0x45, 0x03, 0x75, 0x0D }, 30)]
    [InlineData(new byte[] { 0x01, 0x30, 0x30, 0x41, 0x44, 0x31, 0x32, 0x02, 0x30, 0x30, 0x30, 0x30, 0x36, 0x32, 0x30, 0x30, 0x30, 0x30, 0x36, 0x34, 0x30, 0x30, 0x36, 0x34, 0x03, 0x03, 0x0D }, 100)]
    public void ResponseHandler_HandlesVolumeLevelResponses(byte[] response, byte expectedVolumeLevel)
    {
        _mockClient.Object.ResponseByteHandlers!.Invoke(response);
        _mockVolumeLevelHandler.Verify(x => x.Invoke(expectedVolumeLevel));
    }
    
    [Fact]
    public void ResponseHandler_HandlesPartialVolumeLevelResponses()
    {
        var response1 = new byte[] { 0x01, 0x30, 0x30, 0x41, 0x44, 0x31, 0x32, 0x02, 0x30, 0x30, 0x30, 0x30, 0x36, 0x32, 0x30 };
        var response2 = new byte[] { 0x30, 0x30, 0x30,0x36, 0x34, 0x30, 0x30, 0x30, 0x30, 0x03, 0x01, 0x0D }; 
            
        _mockClient.Object.ResponseByteHandlers!.Invoke(response1);
        _mockClient.Object.ResponseByteHandlers!.Invoke(response2);
        _mockVolumeLevelHandler.Verify(x => x.Invoke(0));
    }

    [Fact]
    public void ResponseHandler_HandlesMultipleResponcesInTheOnePayload()
    {
        var response1 = new byte[] { 0x01, 0x30, 0x30, 0x41, 0x42, 0x31, 0x32, 0x02, 0x30, 0x32, 0x30, 0x30, 0x44 };
        var response2 = new byte[] { 0x36, 0x30, 0x30, 0x30, 0x30, 0x30, 0x34, 0x30, 0x30, 0x30, 0x31, 0x03, 0x74 };        
        var response3 = new byte[] { 0x0D, 0x01, 0x30, 0x30, 0x41, 0x44, 0x31, 0x32, 0x02, 0x30, 0x30, 0x30, 0x30 };
        var response4 = new byte[] { 0x36, 0x30, 0x30, 0x30, 0x30, 0x30, 0x38, 0x38, 0x30, 0x30, 0x31, 0x31, 0x03 };        
        var response5 = new byte[] { 0x01, 0x0D, 0x01, 0x30, 0x30, 0x41, 0x44, 0x31, 0x32, 0x02, 0x30, 0x30, 0x30 };
        var response6 = new byte[] { 0x30, 0x36, 0x32, 0x30, 0x30, 0x30, 0x30, 0x36, 0x34, 0x30, 0x30, 0x30, 0x30 };
        var response7 = new byte[] { 0x03, 0x01, 0x0D }; 
            
        _mockClient.Object.ResponseByteHandlers!.Invoke(response1);
        _mockClient.Object.ResponseByteHandlers!.Invoke(response2);
        _mockClient.Object.ResponseByteHandlers!.Invoke(response3);
        _mockClient.Object.ResponseByteHandlers!.Invoke(response4);
        _mockClient.Object.ResponseByteHandlers!.Invoke(response5);
        _mockClient.Object.ResponseByteHandlers!.Invoke(response6);
        _mockClient.Object.ResponseByteHandlers!.Invoke(response7);
        _mockPowerStateHandler.Verify(x => x.Invoke(PowerState.On));
        _mockInputHandler.Verify(x => x.Invoke(Input.Hdmi1));
        _mockVolumeLevelHandler.Verify(x => x.Invoke(0));
    }
}