using AVCoders.Core;
using AVCoders.Core.Tests;
using Moq;

namespace AVCoders.Display.Tests;

public class ColorlightDeviceControlProtocolClassBTest
{

    private readonly Mock<TcpClient> _mockClient = TestFactory.CreateTcpClient(ColorlightDeviceControlProtocolClassB.TcpPort);
    private readonly ColorlightDeviceControlProtocolClassB _display;

    public ColorlightDeviceControlProtocolClassBTest()
    {
        _display = new ColorlightDeviceControlProtocolClassB(_mockClient.Object, "LED Wall");
    }

    [Fact]
    public void Module_RespondsToHeartbeat()
    {
        _mockClient.Object.ResponseByteHandlers!.Invoke([0x99, 0x99, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00]);

        _mockClient.Verify(x => x.Send(new byte[] { 0x99, 0x99, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00 }));
    }

    [Fact]
    public void Module_RespondsToHeartbeatsChainedTogether()
    {
        _mockClient.Object.ResponseByteHandlers!.Invoke([0x99, 0x99, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x99, 0x99, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x99, 0x99, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x99, 0x99, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00]);

        _mockClient.Verify(x => x.Send(new byte[] { 0x99, 0x99, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00 }));
    }

    [Fact]
    public void PowerOn_DisablesBlackout()
    {
        _display.PowerOn();
        
        _mockClient.Verify(x => x.Send(new byte[] { 0x10, 0x10, 0x00, 0x12, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }));
    }

    [Fact]
    public void PowerOff_EnablesBlackout()
    {
        _display.PowerOff();
        
        _mockClient.Verify(x => x.Send(new byte[] { 0x10, 0x10, 0x00, 0x12, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01 }));
    }

    [Theory]
    [InlineData(0, new byte[] { 0x50, 0x10, 0x00, 0x13, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 })]
    [InlineData(50, new byte[] { 0x50, 0x10, 0x00, 0x13, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x88, 0x13 })]
    [InlineData(100, new byte[] { 0x50, 0x10, 0x00, 0x13, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x27 })]
    public void SetBrightness_SendsTheCommand(uint brightness, byte[] expectedCommand)
    {
        _display.SetBrightness(brightness);
        
        _mockClient.Verify(x => x.Send(expectedCommand));
    }

    [Fact]
    public void SetBrightness_IgnoresValuesOver100()
    {
        
        _display.SetBrightness(101);
        
        _mockClient.Verify(x => x.Send(It.IsAny<byte[]>()), Times.Never);
    }
}